{% comment -%}
The life and times of Dr John Dee
Copyright (C) 2021  Jordan Cole <feedback@drjohndee.net>

This program is free software: you can redistribute it and/or modify
it under the terms of the GNU Affero General Public License as published
by the Free Software Foundation, either version 3 of the License, or
(at your option) any later version.

This program is distributed in the hope that it will be useful,
but WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
GNU Affero General Public License for more details.

You should have received a copy of the GNU Affero General Public License
along with this program.  If not, see <https://www.gnu.org/licenses/>.
{% endcomment -%}

{% if include.references.size > 0 -%}
<aside class="annotations annotations-footnotes">
  <h1>Footnotes</h1>
  <ul class="annotation-content">
  {% assign previous_source_key = null -%}
  {% for reference in include.references -%}
    {% assign f_record = reference | collection_entry: "footnotes" -%}
    {% if f_record -%}
    {% assign s_record = f_record.source_key | collection_entry: "sources" -%}
    <li itemprop=comment
        itemscope itemtype="https://schema.org/Comment"
        itemid="{{ page.url | relative_url }}#footnote--{{ reference }}">
      {% assign creator_key = f_record.author_key | default: s_record.author_key -%}
      {% include person_data.html person_key=creator_key
                                  itemprop="creator" -%}

      {% assign language = f_record.language | default: s_record.work.language -%}
      <figure lang="{{ language }}" translate>
        <blockquote class="source-material"
                    itemprop=text>
          {% if f_record.symbol -%}
          {{ f_record.symbol }}
          {% endif -%}
          {{ f_record.text | markdownify }}
        </blockquote>

        {% if f_record.source_key -%}
        <figcaption class="caption"
                    itemprop=citation
                    itemscope>
          {% include source_data.html source_key=f_record.source_key
                                      edition_key=f_record.edition_key
                                      location=f_record.location
                                      volume=f_record.volume -%}

          {% if f_record.source_key == previous_source_key -%}
          <a href="{{ f_record.source_key | collection_entry_url: "sources" }}"><abbr>Ibid.</abbr></a>,
          {{ f_record.location }}
          {% else -%}
          {{ f_record.source_key | mla_citation: f_record.location,
                                                 f_record.edition,
                                                 f_record.volume }}
          {% endif -%}

          {% if f_record.author_key != s_record.author_key -%}
          <br>Note written by
          {% include person_link.html person_key=f_record.author_key -%}
          {% endif -%}
        </figcaption>
        {% endif -%}
      </figure>
    </li>
    {% endif -%}
    {% assign previous_source_key = f_record.source_key -%}
  {% endfor -%}
  </ul>
</aside>
{% endif -%}
